var y=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var v=(r,e,t,a)=>{for(var s=a>1?void 0:a?u(e,t):e,o=r.length-1,g;o>=0;o--)(g=r[o])&&(s=(a?g(e,t,s):g(s))||s);return a&&s&&y(e,t,s),s},S=(r,e)=>(t,a)=>e(t,a,r);import{ContainerModule as x}from"inversify";var p=Symbol.for("SaveManagerName");import{saveAs as A}from"file-saver";import{SerializerEngineName as I}from"@aptero/axolotis-module-serializer";import*as f from"localforage";var l=class{localforage;constructor(){this.localforage=f.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};import{inject as L,injectable as b}from"inversify";import{makeid as h}from"@aptero/axolotis-module-id-generator";var i="SAVE-",m="1-LAST-SAVE",c="1.0.0",n=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new l;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(m)}async saveAsFile(e){let t=await this.saveApi.getItem(i+e),a=JSON.parse(t),s=new Blob([t],{type:"application/json"});A(s,a.name+".json")}async loadFromFile(e){let t=await new Promise(a=>{let s=new FileReader;s.onload=function(o){a(o.target.result)},s.readAsText(e,"UTF-8")});return this.loadFromString(t)}async loadFromString(e){let t=h(10);return await this.saveApi.setItem(i+t,e),JSON.parse(e),t}async load(e){await this.setLastSave(e);let t=await this.saveApi.getItem(i+e),a=JSON.parse(t);if(a.version!==c)throw new Error("Incompatibility between save version: "+a.version+"/"+c);console.log("loading save : "+a.name+" / "+a.id);for(let s of this.dataToSave){let o=this.serializeEngine.deserialize(a.zgame[s.key]);s.data.load(o)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=h(10),a={version:c,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let s=JSON.parse(await this.saveApi.getItem(i+e));a={version:c,name:s.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let s of this.dataToSave)a.zgame[s.key]=this.serializeEngine.serialize(s.data.save());return await this.saveApi.setItem(i+e,JSON.stringify(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(i)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(m)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(m))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(m);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(m,e)}async delete(e){console.log("delete : "+i+e),await this.saveApi.removeItem(i+e)}};n=v([b(),S(0,L(I))],n);var d=class{async getItem(e){return localStorage.getItem(e)}async setItem(e,t){return localStorage.setItem(e,t),t}async removeItem(e){return localStorage.removeItem(e)}async keys(){throw new Error}};var w=class{getModule(){return new x(e=>{e(p).to(n).inSingletonScope()})}};export{w as AxSaveModule,l as LocalForageSave,d as LocalStorageSave,n as SaveManager,p as SaveManagerName};
//# sourceMappingURL=index.js.map