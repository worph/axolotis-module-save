var w=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var c=(r,e,t,a)=>{for(var s=a>1?void 0:a?u(e,t):e,o=r.length-1,g;o>=0;o--)(g=r[o])&&(s=(a?g(e,t,s):g(s))||s);return a&&s&&w(e,t,s),s},S=(r,e)=>(t,a)=>e(t,a,r);import{ContainerModule as b}from"inversify";var p=Symbol.for("SaveManagerName");import{saveAs as y}from"file-saver";import{SerializerEngineName as A}from"@aptero/axolotis-module-serializer";import*as f from"localforage";var l=class{localforage;constructor(){this.localforage=f.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};import{inject as I,injectable as L}from"inversify";import{makeid as h}from"@aptero/axolotis-module-id-generator";var i="SAVE-",m="1-LAST-SAVE",v="1.0.0",n=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new l;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(m)}async saveAsFile(e){let t=await this.saveApi.getItem(i+e),a=JSON.parse(t),s=new Blob([t],{type:"application/json"});y(s,a.name+".json")}async loadFromFile(e){let t=await new Promise(a=>{let s=new FileReader;s.onload=function(o){a(o.target.result)},s.readAsText(e,"UTF-8")});return this.loadFromString(t)}async loadFromString(e){let t=h(10);await this.saveApi.setItem(i+t,e);let a=this.serializeEngine.deserializeFromString(e);return t}async load(e){await this.setLastSave(e);let t=this.serializeEngine.deserializeFromString(await this.saveApi.getItem(i+e));if(t.version!==v)throw new Error("Incompatibility between save version: "+t.version+"/"+v);console.log("loading save : "+t.name+" / "+t.id);for(let a of this.dataToSave){let s=t.zgame[a.key];a.data.load(s)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=h(10),a={version:v,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let s=JSON.parse(await this.saveApi.getItem(i+e));a={version:v,name:s.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let s of this.dataToSave)a.zgame[s.key]=s.data.save();return await this.saveApi.setItem(i+e,this.serializeEngine.serializeToString(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(i)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(m)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(m))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(m);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(m,e)}async delete(e){console.log("delete : "+i+e),await this.saveApi.removeItem(i+e)}};n=c([L(),S(0,I(A))],n);var d=class{getModule(){return new b(e=>{e(p).to(n).inSingletonScope()})}};export{d as AxSaveModule,n as SaveManager,p as SaveManagerName};
//# sourceMappingURL=index.js.map