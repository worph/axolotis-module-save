var d=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var g=(i,e,t,a)=>{for(var s=a>1?void 0:a?w(e,t):e,v=i.length-1,c;v>=0;v--)(c=i[v])&&(s=(a?c(e,t,s):c(s))||s);return a&&s&&d(e,t,s),s},S=(i,e)=>(t,a)=>e(t,a,i);import{ContainerModule as L}from"inversify";var p=Symbol.for("SaveManagerName");import{saveAs as u}from"file-saver";import{SerializerEngineName as y}from"@aptero/axolotis-module-serializer";import*as f from"localforage";var l=class{localforage;constructor(){this.localforage=f.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};import{inject as A,injectable as I}from"inversify";import{makeid as b}from"@aptero/axolotis-module-id-generator";var r="SAVE-",n="1-LAST-SAVE",m="1.0.0",o=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new l;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(n)}async saveAsFile(e){let t=await this.saveApi.getItem(r+e),a=JSON.parse(t),s=new Blob([t],{type:"application/json"});u(s,a.name+".json")}loadAsFile(){throw new Error("unimplemented")}async load(e){await this.setLastSave(e);let t=this.serializeEngine.deserializeFromString(await this.saveApi.getItem(r+e));if(t.version!==m)throw new Error("Incompatibility between save version: "+t.version+"/"+m);console.log("loading save : "+t.name+" / "+t.id);for(let a of this.dataToSave){let s=t.zgame[a.key];a.data.load(s)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=b(10),a={version:m,serializeID:null,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let s=JSON.parse(await this.saveApi.getItem(r+e));a={version:m,serializeID:null,name:s.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let s of this.dataToSave)a.zgame[s.key]=s.data.save();return await this.saveApi.setItem(r+e,this.serializeEngine.serializeToString(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(r)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(n)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(n))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(n);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(n,e)}async delete(e){console.log("delete : "+r+e),await this.saveApi.removeItem(r+e)}};o=g([I(),S(0,A(y))],o);var h=class{getModule(){return new L(e=>{e(p).to(o).inSingletonScope()})}};export{h as AxSaveModule,o as SaveManager,p as SaveManagerName};
//# sourceMappingURL=index.js.map