var E=Object.create;var m=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var T=(r,e)=>{for(var t in e)m(r,t,{get:e[t],enumerable:!0})},y=(r,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of P(e))!N.call(r,s)&&s!==t&&m(r,s,{get:()=>e[s],enumerable:!(a=w(e,s))||a.enumerable});return r};var F=(r,e,t)=>(t=r!=null?E(z(r)):{},y(e||!r||!r.__esModule?m(t,"default",{value:r,enumerable:!0}):t,r)),k=r=>y(m({},"__esModule",{value:!0}),r),u=(r,e,t,a)=>{for(var s=a>1?void 0:a?w(e,t):e,o=r.length-1,S;o>=0;o--)(S=r[o])&&(s=(a?S(e,t,s):S(s))||s);return a&&s&&m(e,t,s),s},A=(r,e)=>(t,a)=>e(t,a,r);var O={};T(O,{AxSaveModule:()=>d,LocalForageSave:()=>l,LocalStorageSave:()=>h,SaveManager:()=>n,SaveManagerName:()=>p});module.exports=k(O);var x=require("inversify");var p=Symbol.for("SaveManagerName");var L=require("file-saver"),b=require("@aptero/axolotis-module-serializer");var I=F(require("localforage"),1),l=class{localforage;constructor(){this.localforage=I.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};var v=require("inversify"),f=require("@aptero/axolotis-module-id-generator");var i="SAVE-",c="1-LAST-SAVE",g="1.0.0",n=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new l;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(c)}async saveAsFile(e){let t=await this.saveApi.getItem(i+e),a=JSON.parse(t),s=new Blob([t],{type:"application/json"});(0,L.saveAs)(s,a.name+".json")}async loadFromFile(e){let t=await new Promise(a=>{let s=new FileReader;s.onload=function(o){a(o.target.result)},s.readAsText(e,"UTF-8")});return this.loadFromString(t)}async loadFromString(e){let t=(0,f.makeid)(10);return await this.saveApi.setItem(i+t,e),JSON.parse(e),t}async load(e){await this.setLastSave(e);let t=await this.saveApi.getItem(i+e),a=JSON.parse(t);if(a.version!==g)throw new Error("Incompatibility between save version: "+a.version+"/"+g);console.log("loading save : "+a.name+" / "+a.id);for(let s of this.dataToSave){let o=this.serializeEngine.deserialize(a.zgame[s.key]);s.data.load(o)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=(0,f.makeid)(10),a={version:g,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let s=JSON.parse(await this.saveApi.getItem(i+e));a={version:g,name:s.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let s of this.dataToSave)a.zgame[s.key]=this.serializeEngine.serialize(s.data.save());return await this.saveApi.setItem(i+e,JSON.stringify(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(i)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(c)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(c))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(c);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(c,e)}async delete(e){console.log("delete : "+i+e),await this.saveApi.removeItem(i+e)}};n=u([(0,v.injectable)(),A(0,(0,v.inject)(b.SerializerEngineName))],n);var h=class{async getItem(e){return localStorage.getItem(e)}async setItem(e,t){return localStorage.setItem(e,t),t}async removeItem(e){return localStorage.removeItem(e)}async keys(){throw new Error}};var d=class{getModule(){return new x.ContainerModule(e=>{e(p).to(n).inSingletonScope()})}};0&&(module.exports={AxSaveModule,LocalForageSave,LocalStorageSave,SaveManager,SaveManagerName});
//# sourceMappingURL=index.cjs.map