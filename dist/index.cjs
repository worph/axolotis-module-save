var z=Object.create;var n=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var N=(s,e)=>{for(var t in e)n(s,t,{get:e[t],enumerable:!0})},d=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of E(e))!x.call(s,i)&&i!==t&&n(s,i,{get:()=>e[i],enumerable:!(a=h(e,i))||a.enumerable});return s};var P=(s,e,t)=>(t=s!=null?z(T(s)):{},d(e||!s||!s.__esModule?n(t,"default",{value:s,enumerable:!0}):t,s)),k=s=>d(n({},"__esModule",{value:!0}),s),w=(s,e,t,a)=>{for(var i=a>1?void 0:a?h(e,t):e,g=s.length-1,S;g>=0;g--)(S=s[g])&&(i=(a?S(e,t,i):S(i))||i);return a&&i&&n(e,t,i),i},u=(s,e)=>(t,a)=>e(t,a,s);var M={};N(M,{AxSaveModule:()=>f,SaveManager:()=>o,SaveManagerName:()=>p});module.exports=k(M);var L=require("inversify");var p=Symbol.for("SaveManagerName");var A=require("file-saver"),I=require("@aptero/axolotis-module-serializer");var y=P(require("localforage"),1),m=class{localforage;constructor(){this.localforage=y.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};var c=require("inversify"),b=require("@aptero/axolotis-module-id-generator");var r="SAVE-",l="1-LAST-SAVE",v="1.0.0",o=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new m;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(l)}async saveAsFile(e){let t=await this.saveApi.getItem(r+e),a=JSON.parse(t),i=new Blob([t],{type:"application/json"});(0,A.saveAs)(i,a.name+".json")}loadAsFile(){throw new Error("unimplemented")}async load(e){await this.setLastSave(e);let t=this.serializeEngine.deserializeFromString(await this.saveApi.getItem(r+e));if(t.version!==v)throw new Error("Incompatibility between save version: "+t.version+"/"+v);console.log("loading save : "+t.name+" / "+t.id);for(let a of this.dataToSave){let i=t.zgame[a.key];a.data.load(i)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=(0,b.makeid)(10),a={version:v,serializeID:null,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let i=JSON.parse(await this.saveApi.getItem(r+e));a={version:v,serializeID:null,name:i.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let i of this.dataToSave)a.zgame[i.key]=i.data.save();return await this.saveApi.setItem(r+e,this.serializeEngine.serializeToString(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(r)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(l)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(l))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(l);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(l,e)}async delete(e){console.log("delete : "+r+e),await this.saveApi.removeItem(r+e)}};o=w([(0,c.injectable)(),u(0,(0,c.inject)(I.SerializerEngineName))],o);var f=class{getModule(){return new L.ContainerModule(e=>{e(p).to(o).inSingletonScope()})}};0&&(module.exports={AxSaveModule,SaveManager,SaveManagerName});
//# sourceMappingURL=index.cjs.map