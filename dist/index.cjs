var E=Object.create;var m=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var x=(i,e)=>{for(var t in e)m(i,t,{get:e[t],enumerable:!0})},w=(i,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of z(e))!T.call(i,s)&&s!==t&&m(i,s,{get:()=>e[s],enumerable:!(a=d(e,s))||a.enumerable});return i};var P=(i,e,t)=>(t=i!=null?E(N(i)):{},w(e||!i||!i.__esModule?m(t,"default",{value:i,enumerable:!0}):t,i)),F=i=>w(m({},"__esModule",{value:!0}),i),u=(i,e,t,a)=>{for(var s=a>1?void 0:a?d(e,t):e,o=i.length-1,S;o>=0;o--)(S=i[o])&&(s=(a?S(e,t,s):S(s))||s);return a&&s&&m(e,t,s),s},y=(i,e)=>(t,a)=>e(t,a,i);var O={};x(O,{AxSaveModule:()=>h,SaveManager:()=>n,SaveManagerName:()=>p});module.exports=F(O);var b=require("inversify");var p=Symbol.for("SaveManagerName");var I=require("file-saver"),L=require("@aptero/axolotis-module-serializer");var A=P(require("localforage"),1),v=class{localforage;constructor(){this.localforage=A.createInstance({name:"saves"})}async getItem(e){return this.localforage.getItem(e)}async setItem(e,t){return this.localforage.setItem(e,t)}async removeItem(e){return this.localforage.removeItem(e)}async keys(){return this.localforage.keys()}};var g=require("inversify"),f=require("@aptero/axolotis-module-id-generator");var r="SAVE-",l="1-LAST-SAVE",c="1.0.0",n=class{constructor(e){this.serializeEngine=e}dataToSave=[];saveApi=new v;registerSavable(e,t){if(!t)throw new Error;this.dataToSave.push({key:e,data:t})}async isCreateNew(){return!await this.saveApi.getItem(l)}async saveAsFile(e){let t=await this.saveApi.getItem(r+e),a=JSON.parse(t),s=new Blob([t],{type:"application/json"});(0,I.saveAs)(s,a.name+".json")}async loadFromFile(e){let t=await new Promise(a=>{let s=new FileReader;s.onload=function(o){a(o.target.result)},s.readAsText(e,"UTF-8")});return this.loadFromString(t)}async loadFromString(e){let t=(0,f.makeid)(10);return await this.saveApi.setItem(r+t,e),JSON.parse(e),t}async load(e){await this.setLastSave(e);let t=await this.saveApi.getItem(r+e),a=JSON.parse(t);if(a.version!==c)throw new Error("Incompatibility between save version: "+a.version+"/"+c);console.log("loading save : "+a.name+" / "+a.id);for(let s of this.dataToSave){let o=this.serializeEngine.deserialize(a.zgame[s.key]);s.data.load(o)}}async save(e=null,t="New Save"){await this.setLastSave(e);let a;if(!e)e=(0,f.makeid)(10),a={version:c,name:t,id:e,date:new Date().toISOString(),zgame:{}};else{let s=JSON.parse(await this.saveApi.getItem(r+e));a={version:c,name:s.name,id:e,date:new Date().toISOString(),zgame:{}}}for(let s of this.dataToSave)a.zgame[s.key]=this.serializeEngine.serialize(s.data.save());return await this.saveApi.setItem(r+e,JSON.stringify(a)),e}async listSaves(){let e=[];for(let t of await this.saveApi.keys())if(t.startsWith(r)){let a=JSON.parse(await this.saveApi.getItem(t));e.push({id:a.id,name:a.name,date:new Date(a.date)})}return e.sort(function(t,a){return a.date-t.date}),e}async fetchLastSave(){if(!await this.saveApi.getItem(l)){let e=await this.listSaves();e.length>0?await this.setLastSave(e[0].id):await this.setLastSave(await this.save(null))}}async saveLast(){await this.fetchLastSave(),await this.save(await this.saveApi.getItem(l))}async loadLast(){await this.fetchLastSave();let e=await this.saveApi.getItem(l);await this.load(e)}async setLastSave(e){await this.saveApi.setItem(l,e)}async delete(e){console.log("delete : "+r+e),await this.saveApi.removeItem(r+e)}};n=u([(0,g.injectable)(),y(0,(0,g.inject)(L.SerializerEngineName))],n);var h=class{getModule(){return new b.ContainerModule(e=>{e(p).to(n).inSingletonScope()})}};0&&(module.exports={AxSaveModule,SaveManager,SaveManagerName});
//# sourceMappingURL=index.cjs.map